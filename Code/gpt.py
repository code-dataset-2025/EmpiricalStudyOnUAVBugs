import openai
import time

def use_openai_api(words,api_key):
    openai.api_key = api_key
    # openai.base_url = url
    openai.base_url = ''
    response = openai.chat.completions.create(
        model="gpt-4o",  # 确认使用 GPT-4o 模型
        messages=[
            {"role": "user", "content": words}
        ]
    )
    #print(response)
    return response

def total_counts(tokens_in_now,tokens_out_now,cost_now,response):
    #print(response)
    tokens_in_now=int(response.usage.prompt_tokens)
    tokens_out_now=int(response.usage.completion_tokens)
    price_in=0.01/1000
    price_out=0.03/1000
    cost_now+=(price_in*tokens_in_now+price_out*tokens_out_now)
    current_time = time.strftime('%Y年%m月%d日%H点%M分', time.localtime())
    print(f'当前时刻为{current_time},本次任务共消耗了：输入{tokens_in_now}个token，输出{tokens_out_now}个token，当前总计{cost_now}美元')
    with open("token_and_cost.txt","a",encoding='utf-8') as f:
        f.write(f'当前时刻为{current_time},本次任务共消耗了：输入{tokens_in_now}个token，输出{tokens_out_now}个token，当前总计{cost_now}美元'+'\n'*2)
    f.close()

def save_answer(response,save_path):
    answer=response.choices[0].message.content
    with open(save_path,'a',encoding='utf-8') as f:
        f.write(answer)
        f.write('\n')
    f.close()

def read_document(file_path):
    with open(file_path, 'r', encoding='utf-8') as file:
        return file.read()

tokens_in_now=0
tokens_out_now=0
cost_now=0

# urls=[21634, 20826, 20793, 20477, 20374,
#       20260, 19667, 19665, 19348, 19233,
#       19155, 19134, 18750, 18576, 18574,
#       18573, 18385, 18306, 18060, 18014,#20
#       17831, 17769, 17746, 17380, 17323,
#       17244, 17237, 17220, 17192, 17006,
#       16843, 16813, 16715, 16670, 16586,
#       16390, 16305, 16299, 16278, 16230,#40
#       16129, 16122, 16113, 15922, 15826,
#       15667, 15628, 15501, 15417, 15410,
#       15409, 15408, 15347, 15211, 15042,
#       15037, 14947, 14903, 14840, 14824,#60
#       14802, 14736, 14730, 14718, 14717,
#       14671, 14670, 14649, 14612, 14600,
#       14588, 14579, 14566, 14527, 14479,
#       14456, 14442, 14440, 14439, 14354,#80
#       14303, 14300, 14281, 14260, 14206,
#       14200, 14189, 14157, 14150, 14101,
#       14075, 14011, 13956, 13946, 13752,
#       13751, 13732, 13724, 13688, 13533,#100
#       13471, 13455, 13415, 13377, 13374,
#       13329, 13313, 13309, 13292, 13280,
#       13244, 13180, 13148, 13116, 13055,
#       13012, 12980, 12955, 12932, 12919,#120
#       12879, 12833, 12813, 12761, 12758,
#       12692, 12637, 12517, 12240, 12221,
#       12193, 12190, 12171, 12071, 12029,
#       12006, 11945, 11942, 11929, 11901,#140
#       11899, 11880, 11860, 11847, 11832,
#       11794, 11778, 11750, 11716, 11685,
#       11646, 11551, 11492, 11433, 11408,
#       11386, 11364, 11282, 11238, 11226,#160
#       11198, 11118, 11110, 11006, 10999,
#       10972, 10767, 10693, 10686, 10655,
#       10593, 10571, 10471, 10457, 10412,
#       10092, 9867, 9841, 9768, 9554,#180
#       9513, 9025, 8828, 8303, 8255,
#       7755, 7746, 7457, 7051, 6783,
#       6669, 6282, 6184, 6172, 5887,
#       5465, 5317, 3795, 3117, 500]#200

urls=[24083,24073,24060,24059,24023,23988,23975,23970,23954,23903,23857,23842,23811,23786,23773,23761,23736,23734,23727,23720,23716,23714,23683,23636,23615,23612,23598,23589,23548,23533,23530,23528,23487,23481,23454,23442,23439,23434,23378,23361,23349,23340,23329,23308,23301,23289,23275,23259,23258,23254,23251,23246,23237,23224,23200,23179,23171,23159,23157,23139,23114,23074,23051,23040,23034,23026,23013,22998,22994,22986,22948,22937,22867,22858,22857,22839,22819,22807,22797,22767,22730,22728,22714,22695,22687,22683,22664,22659,22655,22654,22650,22634,22633,22606,22599,22587,22573,22569,22565,22561,22558,22542,22540,22523,22522,22520,22515,22492,22485,22482,22474,22452,22430,22429,22428,22422,22415,22399,22385,22382,22358,22357,22356,22355,22318,22306,22300,22285,22283,22275,22272,22264,22245,22236,22221,22220,22219,22214,22206,22196,22180,22163,22162,22160,22159,22144,22139,22130,22122,22119,22118,22110,22104,22093,22072,22070,22069,22068,22067,22052,22050,22046,22042,22041,22037,22024,22016,22006,22004,22002,22001,21983,21982,21978,21966,21965,21964,21953,21952,21934,21929,21927,21924,21914,21911,21895,21893,21882,21880,21838,21836,21828,21811,21805,21774,21771,21770,21748,21732,21730,21727,21702,21687,21648,21644,21627,21567,21552,21519,21421,21397,21387,21318,21302,21257,21247,21228,21206,21199,21185,21149,21144,21108,21092,21090,21087,20944,20932,20929,20923,20918,20775,20747,20696,20694,20687,20629,20524,20507,20454,20445,20436,20415,20376,20295,20280,20279,20277,20276,20275,20258,20246,20235,20205,20197,20187,20120,20118,20088,20087,20042,19992,19961,19943,19887,19863,19846,19834,19810,19809,19772,19768,19733,19732,19731,19722,19642,19382,19361,19215,19150,19046,19045,19009,18675,18672,18597,18562,18516,18429,18375,18354,18223,18110,18095,18055,18041,17977,17908,17804,17685,17615,17578,17509,17491,17489,17305,17259,17097,17016,16932,16918,16873,16823,16763,16672,16643,16639,16630,16621,16541,16530,16526,16511,16372,16363,16358,16194,16083,16070,16029,16001,15984,15944,15940,15894,15879,15872,15839,15810,15801,15795,15786,15771,15744,15711,15686,15652,15558,15544,15505,15471,15450,15402,15400,15398,15336,15284,15275,15242,15225,15201,15188,15153,15146,15088,15073,15054,15043,15003,14994,14927,14926,14908,14857,14856,14854,14851,14849,14831,14829,14795,14783,14777,14760,14745,14744,14743,14740,14735,14733,14720,14719,14704,14677,14662,14661,14655,14644,14640,14632,14558,14547,14542,14526,14522,14521,14513,14509,14503,14500,14436,14422,14361,14349,14325,14324,14321,14273,14230,14204,14165,14146,14116,14068,13953,13950,13935,13884,13868,13826,13799,13788,13717,13697,13685,13667,13634,13592,13546,13518,13507,13483,13479,13466,13462,13458,13413,13410,13388,13378,13352,13334,13291,13282,13252,13192,13182,13144,13133,13124,13123,13120,13098,13083,13068,13022,12992,12990,12987,12958,12925,12911,12910,12877,12814,12791,12789,12774,12773,12768,12753,12734,12716,12685,12592,12579,12565,12553,12548,12536,12504,12490,12485,12484,12476,12475,12460,12457,12432,12412,12407,12375,12359,12272,12265,12264,12258,12255,12247,12216,12203,12189,12164,12158,12155,12134,12124,12092,12086,12004,11971,11959,11916,11912,11907,11885,11868,11854,11844,11830,11824,11812,11799,11798,11789,11774,11767,11764,11759,11757,11739,11737,11734,11720,11704,11703,11702,11695,11683,11662,11640,11625,11604,11600,11588,11569,11420,11402,11384,11380,11317,11289,11275,11266,11257,11235,11213,11203,11197,11179,11165,11162,11152,11150,11144,11125,11116,11076,11072,11071,11054,11049,11045,11041,11036,11028,11026,11019,11017,11003,10997,10981,10980,10961,10925,10896,10881,10843,10839,10833,10818,10790,10757,10735,10712,10679,10677,10659,10644,10639,10625,10620,10599,10590,10539,10495,10458,10443,10440,10429,10415,10406,10391,10381,10376,10375,10370,10360,10359,10358,10352,10351,10345,10315,10309,10282,10262,10258,10233,10230,10228,10223,10221,10220,10203,10185,10176,10131,10106,10104,10102,10101,10057,10040,10036,10034,10033,10032,10028,10026,10023,9992,9989,9984,9977,9973,9971,9965,9939,9927,9920,9915,9904,9901,9871,9866,9799,9796,9764,9755,9746,9740,9738,9726,9720,9713,9696,9667,9666,9639,9637,9616,9602,9582,9575,9540,9539,9537,9532,9527,9505,9495,9474,9472,9452,9447,9444,9414,9369,9348,9300,9155,9151,9150,9137,9134,9108,9066,9052,9043,9038,9037,9033,9032,9022,9020,9009,8998,8997,8992,8988,8984,8980,8945,8930,8927,8913,8903,8877,8867,8864,8863,8858,8852,8850,8834,8822,8816,8815,8809,8808,8807,8805,8803,8792,8783,8782,8773,8766,8763,8761,8760,8757,8756,8753,8751,8748,8747,8746,8744,8742,8732,8730,8727,8724,8722,8720,8718,8717,8715,8713,8712,8707,8696,8692,8690,8674,8672,8657,8655,8644,8643,8632,8628,8621,8603,8601,8600,8585,8567,8563,8556,8541,8540,8529,8523,8522,8518,8515,8508,8477,8468,8465,8464,8460,8459,8458,8455,8454,8413,8408,8403,8401,8400,8398,8392,8389,8380,8376,8367,8362,8361,8333,8318,8312,8305,8299,8297,8289,8280,8275,8263,8262,8257,8256,8253,8252,8246,8245,8239,8221,8213,8198,8197,8186,8184,8176,8163,8159,8158,8150,8148,8131,8124,8122,8105,8102,8100,8093,8087,8070,8069,8066,8053,8034,7998,7978,7971,7968,7947,7925,7911,7910,7872,7861,7860,7858,7820,7818,7794,7768,7750,7737,7727,7696,7677,7672,7656,7638,7612,7609,7603,7599,7597,7551,7545,7544,7541,7535,7513,7512,7511,7510,7495,7490,7475,7467,7463,7439,7426,7409,7408,7405,7402,7394,7391,7390,7385,7364,7362,7333,7327,7325,7311,7309,7288,7261,7234,7202,7198,7194,7192,7191,7185,7173,7150,7133,7123,7097,7089,7085,7083,7068,7066,7063,7059,7054,7053,7050,7048,7033,7023,7021,7020,7018,7010,6994,6984,6982,6961,6957,6947,6941,6921,6914,6913,6911,6905,6902,6900,6898,6876,6873,6872,6867,6864,6855,6843,6838,6827,6820,6818,6807,6800,6799,6798,6797,6796,6794,6772,6762,6758,6733,6726,6722,6715,6712,6711,6702,6660,6651,6630,6623,6622,6620,6617,6604,6602,6576,6554,6549,6546,6545,6541,6533,6501,6499,6498,6488,6479,6456,6445,6444,6423,6390,6389,6388,6366,6359,6332,6314,6288,6281,6274,6263,6261,6260,6249,6235,6233,6228,6211,6207,6204,6175,6165,6152,6107,6094,6092,6070,6037,5986,5982,5975,5970,5963,5959,5934,5929,5924,5881,5855,5811,5802,5801,5771,5757,5756,5752,5739,5728,5726,5725,5717,5702,5691,5680,5676,5675,5673,5639,5632,5631,5629,5624,5623,5609,5596,5553,5543,5535,5527,5519,5514,5511,5501,5496,5462,5446,5395,5382,5334,5305,5290,5282,5276,5243,5238,5229,5218,5211,5210,5172,5171,5170,5149,5146,5135,5134,5118,5115,5112,5110,5103,5083,5078,5060,5059,5038,4984,4982,4980,4962,4954,4937,4929,4924,4908,4904,4850,4847,4838,4837,4836,4828,4819,4800,4799,4791,4784,4782,4769,4767,4766,4757,4747,4745,4723,4722,4721,4700,4692,4685,4682,4674,4656,4654,4652,4646,4639,4636,4635,4614,4600,4587,4550,4549,4536,4534,4530,4516,4487,4486,4468,4466,4462,4443,4424,4421,4379,4371,4356,4316,4300,4295,4232,4224,4203,4198,4193,4185,4169,4151,4149,4145,4144,4141,4135,4125,4115,4113,4111,4110,4108,4080,4054,3965,3950,3940,3939,3938,3936,3933,3874,3873,3844,3794,3775,3770,3759,3739,3735,3688,3659,3656,3655,3629,3628,3620,3600,3591,3536,3535,3490,3450,3447,3440,3412,3411,3387,3374,3359,3333,3332,3324,3286,3283,3265,3264,3255,3251,3228,3212,3180,3163,3162,3160,3159,3146,3132,3122,3108,3082,3046,2998,2977,2975,2971,2966,2951,2942,2915,2912,2898,2893,2810,2768,2727,2725,2694,2663,2637,2608,2551,2408,2407,2393,2384,2381,2319,2229,2122,2113,2107,2093,2036,2030,1981,1951,1947,1921,1915,1856,1792,1750,1723,1706,1700,1683,1682,1675,1619,1603,1442,1441,1440,1382,1328,1311,1307,1306,1235,1218,1209,1207,1201,1190,1176,1141,1134,1124,1105,1098,1097,1067,1064,1056,1055,1045,1012,996,930,910,872,859,805,789,784,779,773,756,723,722,702,687,665,663,662,650,649,632,623,599,583,561,554,487,435,413,400,386,378,184,164,163,117,103,25,24,23,22,19,13,8,1]

startnum=0
example_content=read_document('./new/example/example.md')
example_output=read_document('./new/example/answer.md')
api_key=''
path='./new/markdown/issue'
for i in range(startnum,1049):
    doc_content=read_document(path+str(urls[i])+'.md')
    words = f"""
    This is a markdown document about bug reports in the open-source flight control system software PX4 Autopilot for drones:\n\n{doc_content}\n\n
    Be sure to extract the report time and commit version of PX4 AutoPilot from it. If the commit version of PX4 AutoPilot is not mentioned, please fill in the content 'not mentioned' here, and Extract the information of the following content in the following format:
    Environment where the bug occurred:
        Hardware environment:
        Software environment:
        Report Author:
        Report time:
        PX4 Autopilot commit version:
    \n\n 
    Here is an example for you:
    For document:\n\n{example_content}\n\n
    The output should be following:\n\n{example_output}\n\n
    """
    response=use_openai_api(words,api_key)
    answer=response.choices[0].message.content
    save_answer(response,'./new/answer/issue'+str(urls[i])+'.md')
    print('Issue'+str(urls[i])+'.md'+'done! This is No.'+str(i))
# #total_counts(tokens_in_now,tokens_out_now,cost_now,response)
# #save_answer(response)
# response=use_openai_api(words,api_key)
# answer=response.choices[0].message.content
# print(answer)
