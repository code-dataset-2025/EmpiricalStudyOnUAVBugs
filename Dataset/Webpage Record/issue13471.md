# Basic Information:
### Title:  v1.10.0-rc quadcopter doesn't take off in HITL/jMAVsim  #13471 
### Issue status: Closed
### Author: langrind
### Issue open time: Nov 14, 2019
# Report
### Report author: langrind
### Report Time: Nov 14, 2019
### Report Content:   
Describe the bug    
Set up HITL simulation with jMAVsim on Ubuntu 18.04,  Pixhawk 4 with v1.10.0-rc, locally built px4_fmu-v5-multicopter.  
To Reproduce    
Steps to reproduce the behavior:  
1.Follow the recipe from px4 website  
2.Using Manual/Stabilized mode, arm vehicle and apply throttle  
3.Vehicle does not take off  
4.Mavlink shell (listener command) shows actuator_outputs_1 with valid values and actuator_outputs_0 with 0 values  
Expected behavior    
SERVO_OUTPUT_RAW or HIL_ACTUATOR_CONTROLS should follow actuator_outputs_1 and the vehicle should take off in simulation  
Log Files and Screenshots    
Flight Review Link  
Add screenshots to help explain your problem.  
Drone:  
- Pixhawk4 running in HITL Quad Mode  
- Photo of the IMU / autopilot setup if possible.    

# Comment
## Comment1
### Comment author: julianoes
### Comment Time: Nov 15, 2019
### Comment Content:   
That's not good but thanks for the detailed report!  

## Comment2
### Comment author: langrind
### Comment Time: Nov 15, 2019
### Comment Content:   
Originally I stated : "MAVLink inspector in QGC shows no HIL_ACTUATOR_CONTROLS, and SERVO_OUTPUT_RAW values are all 0".  
But this is misleading. The MAVLink Inspector in QGC can only show the messages forwarded by jMAVSim. What's more interesting is:  
1.Once the problem is happening, kill the simulator  
2.Connect QGC to the Pixhawk via USB  
3.Use the MAVLink inspector  
This shows:  
- HIL_ACTUATOR_CONTROLS is generated by the Pixhawk, but it is all zeros  
- SERVO_OUTPUT_RAW flips back and forth between all-zeros sometimes and correct (or at least sensible) values other times  
It seems to me that the publication of uOrbs actuator_outputs instance 0 and instance 1 is confusing the mavlink module's generation of HIL_ACTUATOR_CONTROLS and SERVO_OUTPUT_RAW.  
    
```bash     
 listener actuator_outputs        
TOPIC: actuator_outputs 2 instances        
Instance 0:        
 actuator_outputs_s        
	timestamp: 712451977  (0.010010 seconds ago)        
	noutputs: 8        
	output: [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000]        
Instance 1:        
 actuator_outputs_s        
	timestamp: 712226919  (0.236525 seconds ago)        
	noutputs: 12        
	output: [1358.0000, 1408.0000, 1515.0000, 1323.0000, 1500.0000, 1500.0000, 900.0000, 900.0000, 1500.0000, 1500.0000, 1500.0000, 1500.0000, 0.0000, 0.0000, 0.0000, 0.0000]        
```  
If only instance 0 was published, and it had the correct values, I bet it would work.  
Also, I tested a Pixhawk 2.1 (Cube) running px4_fmu-v3_default, and the behavior was 100% identical.  

## Comment3
### Comment author: langrind
### Comment Time: Nov 15, 2019
### Comment Content:   
This change causes the HIL_ACTUATOR_CONTROLS mavlink message to have non-zero values, and now the drone takes off in jMAVSim and I can fly around Zurich crashing into virtual trees:  
    
```bash     
 langrind@nik:~/Firmware$ git diff        
diff --git a/src/modules/mavlink/mavlink_messages.cpp b/src/modules/mavlink/mavlink_messages.cpp        
index 61a55b8b22..4e258c6165 100644        
--- a/src/modules/mavlink/mavlink_messages.cpp        
+++ b/src/modules/mavlink/mavlink_messages.cpp        
@@ -3065,7 +3065,7 @@ private:        
 protected:        
        explicit MavlinkStreamHILActuatorControls(Mavlink *mavlink) : MavlinkStream(mavlink),        
                _status_sub(_mavlink->add_orb_subscription(ORB_ID(vehicle_status))),        
-               _act_sub(_mavlink->add_orb_subscription(ORB_ID(actuator_outputs))),        
+              _act_sub(_mavlink->add_orb_subscription(ORB_ID(actuator_outputs), 1)),        
                _act_time(0)        
```  
I wonder if this is the correct fix?  

## Comment4
### Comment author: langrind
### Comment Time: Nov 16, 2019
### Comment Content:   
\\\#13488 is my proposed fix  
